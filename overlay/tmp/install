#!/bin/sh

set -euo pipefail
export BF_E=`basename ${0}`


#======================================================================================================================
# Add postgres user.
#======================================================================================================================

bf-adduser postgres


#======================================================================================================================
# Get PostgreSQL version.
#======================================================================================================================

cd /tmp

VERSION=$(cat VERSION)
bf-debug "PostgreSQL version ${VERSION}."


#======================================================================================================================
# Install PostgreSQL and dependencies.
#======================================================================================================================

bf-echo "Installing PostgreSQL v${VERSION}..."
apk add --no-cache \
    postgresql=${VERSION}
bf-done


#======================================================================================================================
# Create PostgreSQL directories.
#======================================================================================================================

bf-debug "Creating PostgreSQL directories."

mkdir -p /var/lib/postgresql/data
mkdir /var/lib/postgresql/backup


#======================================================================================================================
# Add backup executable to main cron.
#======================================================================================================================

bf-debug "Adding db-backup to cron."
echo "0 */8 * * * /usr/local/bin/db-backup" >> /etc/crontabs/root
