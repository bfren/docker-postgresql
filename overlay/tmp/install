#!/bin/sh

set -euo pipefail
export BF_E=`basename ${0}`


#======================================================================================================================
# Add postgres user.
#======================================================================================================================

bf-adduser postgres


#======================================================================================================================
# Get PostgreSQL version.
#======================================================================================================================

cd /tmp

VERSION=$(cat VERSION)
bf-debug "PostgreSQL version ${VERSION}."


#======================================================================================================================
# Install PostgreSQL and dependencies.
#======================================================================================================================

bf-echo "Installing PostgreSQL v${VERSION}..."

if [ "$(echo ${VERSION} | cut -c 2)" == "14" ] ; then
    apk add --no-cache \
        postgresql14=${VERSION}
else
    apk add --no-cache \
        postgresql=${VERSION}
fi

bf-done


#======================================================================================================================
# Create PostgreSQL directories.
#======================================================================================================================

bf-debug "Creating PostgreSQL directories."

mkdir /data
mkdir /backup
mkdir /run/postgresql


#======================================================================================================================
# Add backup executable to main cron.
#======================================================================================================================

bf-debug "Adding db-backup to cron."
echo "0 */8 * * * /usr/local/bin/db-backup" >> /etc/crontabs/root
